# DNN Compiler

The DNN Compiler is a python-based tool developed by the Sony ISDC firmware team
to convert a DNN from a Tensorflow TFLite File (.tflite) or PyTorch code
to auto-generated C source files and/or .bin files targeted for deployment on 
Sony image sensors (IMX681 or similar).

## Dependencies

The DNN Compiler as the following dependencies, and has been tested with the 
versions listed:

| Package                | Version   | Install Command                         |
| ---------------------- | --------- | --------------------------------------- |
| python                 | 3.6.7     |                                         |
| flatbuffers            | 1.12      |  `pip install flatbuffers`              |
| numpy                  | 1.18.5    |  `pip install numpy`                    |
| pytorch                | 1.10      |  `pip install torch torchvision`        | 
| OpenCV                 | 4.5.4     |  `pip install opencv-python`            |

The compiler has only been tested in a Windows command prompt.

## Usage

The DNN compiler's usage is different whether it is being using on a DNN that
originated from Tensorflow or a DNN that originated from Pytorch.

### Tensorflow

For Tensorflow, a pre-trained DNN is saved to a .tflite file. Then, the DNN 
compiler is run as a standalone tool as follows:

```
python dnn_compiler.py [config-file]
```

[config-file] is the path to a DNN Compiler configuration file that defines file
paths, output modes, memory locations, and other runtime parameters for the
compiler. Examples are included in the `configs` directory. 

For Tensorflow the `DNN_MODEL` configuration parameter specifies the path to the
.tflite file to load data from.

For complete usage and command line options, run the following:

```
python dnn_compiler.py --help
```

### Pytorch

For Pytorch, the DNN compiler is run inline in the python code that creates the
PyTorch model as a function call:

```
import dnn_compiler
dnn_compiler.run([config-file], [model-object])
```

[config-file] is the path to a DNN Compiler configuration file that defines file
paths, output modes, memory locations, and other runtime parameters for the
compiler. Examples are included in the `configs` directory. 

[model-object] is the object that represents the DNN model.

For sample programs that create a DNN and call the DNN compiler, see the
`sample_code` directory.

## Output Files

When the compiler runs, it will always generate the following file:

* `[dnn_name]_summary.txt`: a human readable file describing the size and memory
  location of each data structure, register settings, layers in the DNN, 
  estimated processing time, and more.

Based on the output mode, it will also generate one of the following sets of files:

OUTPUT_MODE = i2c
* `[dnn_name]_load_sequence_i2c.bin`: binary file containing a series of I2C writes
  to load the DNN and configure the sensor to use it
* `[dnn_name]_dnn_memory.bin`: binary file containing weights/biases and any other
  data structures that need to be loaded into DNN memory
* `[dnn_name]_system_memory.bin`: binary file containing the optable and any other
  data structures that need to be loaded into system RAM
* `[dnn_name]_registers.txt`: Text file containing register values and other 
  information needed by the DNN Simulator to run this DNN.

## Simulation
Provided separately, the DNN Simulator is a SW tool that can run a DNN from the 
output files generated by the DNN compiler and produce the same output the sensor
firmware will.

To generate the necessary information the DNN compiler needs to be run with the
configuration `OUTPUT_MODE=i2c`. 

The DNN compiler also needs to generate the files with the native byte order of
the simulation host computer; `OUTPUT_ENDIANNESS=little` or `OUTPUT_ENDIANNESS=big`.

When generating for simulation use the normal configuration file and override 
these specific options for the simulator.

For a Tensorflow model these options can overridden on the command line
```
python dnn_compiler.py [config-file] OUTPUT_ENDIANNESS=little
```

For a Pytorch model the configuration overrides are provided as a list to the
`dnn_compiler.run` function.  
```
dnn_compiler.run("../../configs/test/imx681_test_pytorch_sim.cfg", model, config_overrides=["OUTPUT_ENDIANNESS=little"])
```

## Tools

A bin2def tool is provided in the `tools\bin2def` directory. This tool converts
DNN compiler output (I2C load sequence or memory images) to .def files that can be
used to load the DNN via SSP-300.
